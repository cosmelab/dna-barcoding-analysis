name: Auto-Grading

on:
  push:
    branches: [ main ]
    paths:
      - 'results/**'
      - 'submission/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'results/**'
      - 'submission/**'
  workflow_dispatch:

jobs:
  check-completion:
    runs-on: ubuntu-latest

    env:
      # CONFIGURE DEADLINE HERE (Format: YYYY-MM-DD HH:MM:SS UTC)
      # December 12, 2025 at 11:59 PM PST = December 13, 2025 at 07:59 AM UTC
      ASSIGNMENT_DEADLINE: "2025-12-13 07:59:00"
      # Set to 'true' to enforce deadline (reject late submissions)
      # Set to 'false' to allow late submissions but mark them
      STRICT_DEADLINE: "false"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Check Deadline
      id: deadline
      run: |
        echo "Checking submission deadline..."

        # Get current UTC time
        CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
        DEADLINE="${ASSIGNMENT_DEADLINE}"

        echo "Current time (UTC): $CURRENT_TIME"
        echo "Deadline (UTC):     $DEADLINE"

        # Convert to epoch for comparison
        CURRENT_EPOCH=$(date -d "$CURRENT_TIME" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$CURRENT_TIME" +%s)
        DEADLINE_EPOCH=$(date -d "$DEADLINE" +%s 2>/dev/null || date -j -f "%Y-%m-%d %H:%M:%S" "$DEADLINE" +%s)

        if [ $CURRENT_EPOCH -gt $DEADLINE_EPOCH ]; then
          HOURS_LATE=$(( ($CURRENT_EPOCH - $DEADLINE_EPOCH) / 3600 ))
          echo "‚ö†Ô∏è  LATE SUBMISSION: ${HOURS_LATE} hours after deadline"
          echo "is_late=true" >> $GITHUB_OUTPUT
          echo "hours_late=$HOURS_LATE" >> $GITHUB_OUTPUT

          if [ "$STRICT_DEADLINE" = "true" ]; then
            echo "‚ùå STRICT DEADLINE ENFORCED - Late submissions not accepted"
            echo "Please contact your instructor about late submission policy."
            exit 1
          else
            echo "‚ö†Ô∏è  Proceeding with grading (late submission will be noted)"
          fi
        else
          echo "‚úÖ Submitted on time"
          echo "is_late=false" >> $GITHUB_OUTPUT
          echo "hours_late=0" >> $GITHUB_OUTPUT
        fi

    - name: Check Tutorial Completion
      id: tutorial
      run: |
        echo "Checking tutorial completion..."
        TUTORIAL_DIR="results/tutorial"

        # Check if tutorial directory exists
        if [ ! -d "$TUTORIAL_DIR" ]; then
          echo "‚ùå Tutorial not completed: results/tutorial/ directory not found"
          echo "tutorial_completed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check for required output files from tutorial
        REQUIRED_FILES=(
          "$TUTORIAL_DIR/01_qc/qc_report.html"
          "$TUTORIAL_DIR/02_consensus/consensus_report.html"
          "$TUTORIAL_DIR/03_alignment/aligned_sequences.fasta"
          "$TUTORIAL_DIR/04_phylogeny/tree.treefile"
          "$TUTORIAL_DIR/05_blast/identification_report.html"
        )

        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done

        if [ ${#MISSING_FILES[@]} -eq 0 ]; then
          echo "‚úÖ Tutorial completed successfully!"
          echo "   All required output files found in results/tutorial/"
          echo "tutorial_completed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  Tutorial incomplete - missing files:"
          for file in "${MISSING_FILES[@]}"; do
            echo "   - $file"
          done
          echo "tutorial_completed=partial" >> $GITHUB_OUTPUT
        fi

    - name: Check Student Analysis Completion
      id: analysis
      run: |
        echo "Checking student analysis completion..."
        ANALYSIS_DIR="results/my_analysis"

        # Check if analysis directory exists
        if [ ! -d "$ANALYSIS_DIR" ]; then
          echo "‚ùå Analysis not completed: results/my_analysis/ directory not found"
          echo "analysis_completed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check for required output files from student analysis
        REQUIRED_FILES=(
          "$ANALYSIS_DIR/01_qc/qc_report.html"
          "$ANALYSIS_DIR/02_consensus/consensus_sequences.fasta"
          "$ANALYSIS_DIR/04_phylogeny/tree.png"
          "$ANALYSIS_DIR/05_blast/identification_report.html"
        )

        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done

        if [ ${#MISSING_FILES[@]} -eq 0 ]; then
          echo "‚úÖ Student analysis completed successfully!"
          echo "   All required output files found in results/my_analysis/"
          echo "analysis_completed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  Student analysis incomplete - missing files:"
          for file in "${MISSING_FILES[@]}"; do
            echo "   - $file"
          done
          echo "analysis_completed=partial" >> $GITHUB_OUTPUT
        fi

    - name: Generate Summary Report
      run: |
        echo "## üìä Assignment Completion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Deadline status
        IS_LATE="${{ steps.deadline.outputs.is_late }}"
        HOURS_LATE="${{ steps.deadline.outputs.hours_late }}"

        if [ "$IS_LATE" = "true" ]; then
          echo "### ‚ö†Ô∏è Submission Status: LATE" >> $GITHUB_STEP_SUMMARY
          echo "Submitted **${HOURS_LATE} hours** after the deadline." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Late submissions may be subject to grade penalties per course policy." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚úÖ Submission Status: On Time" >> $GITHUB_STEP_SUMMARY
          echo "Submitted before the deadline (December 12, 2025 at 11:59 PM PST)." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Tutorial status
        TUTORIAL_STATUS="${{ steps.tutorial.outputs.tutorial_completed }}"
        if [ "$TUTORIAL_STATUS" = "true" ]; then
          echo "### ‚úÖ Tutorial: Complete" >> $GITHUB_STEP_SUMMARY
          echo "Student successfully completed the tutorial using test data." >> $GITHUB_STEP_SUMMARY
        elif [ "$TUTORIAL_STATUS" = "partial" ]; then
          echo "### ‚ö†Ô∏è Tutorial: Incomplete" >> $GITHUB_STEP_SUMMARY
          echo "Tutorial started but some output files are missing. Please complete all 5 steps." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Tutorial: Not Started" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`./tutorial.sh\` first to learn the workflow." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # Analysis status
        ANALYSIS_STATUS="${{ steps.analysis.outputs.analysis_completed }}"
        if [ "$ANALYSIS_STATUS" = "true" ]; then
          echo "### ‚úÖ Student Analysis: Complete" >> $GITHUB_STEP_SUMMARY
          echo "Student successfully analyzed their mosquito sequences." >> $GITHUB_STEP_SUMMARY
        elif [ "$ANALYSIS_STATUS" = "partial" ]; then
          echo "### ‚ö†Ô∏è Student Analysis: Incomplete" >> $GITHUB_STEP_SUMMARY
          echo "Analysis started but some output files are missing. Please complete all 5 steps." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Student Analysis: Not Started" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`./run-analysis.sh\` to analyze your mosquito sequences." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Answers Check" >> $GITHUB_STEP_SUMMARY
        echo "Your answers have been submitted for grading." >> $GITHUB_STEP_SUMMARY
        echo "Detailed results will be available from your instructor." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** This auto-grading checks workflow completion." >> $GITHUB_STEP_SUMMARY
        echo "Your instructor will review detailed results and provide feedback." >> $GITHUB_STEP_SUMMARY

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Grade Assignment Answers
      id: grading
      env:
        ANSWER_KEY: ${{ secrets.ANSWER_KEY_JSON }}
      run: |
        echo "Grading assignment answers..."

        if [ ! -f "submission/answers.json" ]; then
          echo "‚ùå submission/answers.json not found - Please run python3 answer_assignment.py"
          echo "answers_graded=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Create answer key from secret
        echo "$ANSWER_KEY" > /tmp/answer_key.json

        # Run grading script (suppress detailed output from students)
        # Detailed results are saved to a file for instructor review only
        python3 .github/grading/grade_answers.py submission/answers.json /tmp/answer_key.json > /tmp/grading_results.txt 2>&1
        GRADE_EXIT_CODE=$?

        # Clean up answer key
        rm /tmp/answer_key.json

        # Extract just the final score line for student feedback
        FINAL_SCORE=$(grep "FINAL SCORE" /tmp/grading_results.txt || echo "Score: Not available")
        echo "score_line=$FINAL_SCORE" >> $GITHUB_OUTPUT

        # Save full results for instructor (uploaded as artifact)
        mkdir -p /tmp/grading_report
        cp /tmp/grading_results.txt /tmp/grading_report/detailed_results.txt

        if [ $GRADE_EXIT_CODE -eq 0 ]; then
          echo "answers_graded=pass" >> $GITHUB_OUTPUT
        else
          echo "answers_graded=fail" >> $GITHUB_OUTPUT
        fi

    - name: Upload Grading Details (Instructor Only)
      uses: actions/upload-artifact@v4
      with:
        name: grading-details-${{ github.sha }}
        path: /tmp/grading_report/
        retention-days: 90
        if-no-files-found: ignore

    - name: Set Completion Status
      run: |
        TUTORIAL_STATUS="${{ steps.tutorial.outputs.tutorial_completed }}"
        ANALYSIS_STATUS="${{ steps.analysis.outputs.analysis_completed }}"
        ANSWERS_STATUS="${{ steps.grading.outputs.answers_graded }}"

        echo ""
        echo "==================================="
        echo "SUBMISSION STATUS:"
        echo "==================================="
        echo "Tutorial: $TUTORIAL_STATUS"
        echo "Analysis: $ANALYSIS_STATUS"
        echo "Answers submitted: $([ "$ANSWERS_STATUS" != "false" ] && echo "yes" || echo "no")"
        echo "==================================="

        if [ "$TUTORIAL_STATUS" = "true" ] && [ "$ANALYSIS_STATUS" = "true" ] && [ "$ANSWERS_STATUS" != "false" ]; then
          echo "‚úÖ SUBMISSION COMPLETE - All work has been submitted for grading!"
          echo "Your instructor will review your detailed results."
          exit 0
        elif [ "$TUTORIAL_STATUS" = "false" ] && [ "$ANALYSIS_STATUS" = "false" ]; then
          echo "‚ùå NOT STARTED - Please run tutorial.sh and run-analysis.sh"
          exit 1
        elif [ "$ANSWERS_STATUS" = "false" ]; then
          echo "‚ùå ANSWERS MISSING - Please run: python3 answer_assignment.py"
          exit 1
        else
          echo "‚ö†Ô∏è INCOMPLETE - Continue working to complete all parts"
          exit 1
        fi
