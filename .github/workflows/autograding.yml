name: Auto-Grading

on:
  push:
    branches: [ main ]
    paths:
      - 'results/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'results/**'
  workflow_dispatch:

jobs:
  check-completion:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Check Tutorial Completion
      id: tutorial
      run: |
        echo "Checking tutorial completion..."
        TUTORIAL_DIR="results/tutorial"

        # Check if tutorial directory exists
        if [ ! -d "$TUTORIAL_DIR" ]; then
          echo "‚ùå Tutorial not completed: results/tutorial/ directory not found"
          echo "tutorial_completed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check for required output files from tutorial
        REQUIRED_FILES=(
          "$TUTORIAL_DIR/01_qc/qc_report.html"
          "$TUTORIAL_DIR/02_consensus/consensus_report.html"
          "$TUTORIAL_DIR/03_alignment/aligned_sequences.fasta"
          "$TUTORIAL_DIR/04_phylogeny/tree.treefile"
          "$TUTORIAL_DIR/05_blast/identification_report.html"
        )

        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done

        if [ ${#MISSING_FILES[@]} -eq 0 ]; then
          echo "‚úÖ Tutorial completed successfully!"
          echo "   All required output files found in results/tutorial/"
          echo "tutorial_completed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  Tutorial incomplete - missing files:"
          for file in "${MISSING_FILES[@]}"; do
            echo "   - $file"
          done
          echo "tutorial_completed=partial" >> $GITHUB_OUTPUT
        fi

    - name: Check Student Analysis Completion
      id: analysis
      run: |
        echo "Checking student analysis completion..."
        ANALYSIS_DIR="results/my_analysis"

        # Check if analysis directory exists
        if [ ! -d "$ANALYSIS_DIR" ]; then
          echo "‚ùå Analysis not completed: results/my_analysis/ directory not found"
          echo "analysis_completed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Check for required output files from student analysis
        REQUIRED_FILES=(
          "$ANALYSIS_DIR/01_qc/qc_report.html"
          "$ANALYSIS_DIR/02_consensus/consensus_sequences.fasta"
          "$ANALYSIS_DIR/04_phylogeny/tree.png"
          "$ANALYSIS_DIR/05_blast/identification_report.html"
        )

        MISSING_FILES=()
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            MISSING_FILES+=("$file")
          fi
        done

        if [ ${#MISSING_FILES[@]} -eq 0 ]; then
          echo "‚úÖ Student analysis completed successfully!"
          echo "   All required output files found in results/my_analysis/"
          echo "analysis_completed=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è  Student analysis incomplete - missing files:"
          for file in "${MISSING_FILES[@]}"; do
            echo "   - $file"
          done
          echo "analysis_completed=partial" >> $GITHUB_OUTPUT
        fi

    - name: Generate Summary Report
      run: |
        echo "## üìä Assignment Completion Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Tutorial status
        TUTORIAL_STATUS="${{ steps.tutorial.outputs.tutorial_completed }}"
        if [ "$TUTORIAL_STATUS" = "true" ]; then
          echo "### ‚úÖ Tutorial: Complete" >> $GITHUB_STEP_SUMMARY
          echo "Student successfully completed the tutorial using test data." >> $GITHUB_STEP_SUMMARY
        elif [ "$TUTORIAL_STATUS" = "partial" ]; then
          echo "### ‚ö†Ô∏è Tutorial: Incomplete" >> $GITHUB_STEP_SUMMARY
          echo "Tutorial started but some output files are missing. Please complete all 5 steps." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Tutorial: Not Started" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`./tutorial.sh\` first to learn the workflow." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        # Analysis status
        ANALYSIS_STATUS="${{ steps.analysis.outputs.analysis_completed }}"
        if [ "$ANALYSIS_STATUS" = "true" ]; then
          echo "### ‚úÖ Student Analysis: Complete" >> $GITHUB_STEP_SUMMARY
          echo "Student successfully analyzed their mosquito sequences." >> $GITHUB_STEP_SUMMARY
        elif [ "$ANALYSIS_STATUS" = "partial" ]; then
          echo "### ‚ö†Ô∏è Student Analysis: Incomplete" >> $GITHUB_STEP_SUMMARY
          echo "Analysis started but some output files are missing. Please complete all 5 steps." >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Student Analysis: Not Started" >> $GITHUB_STEP_SUMMARY
          echo "Please run \`./run-analysis.sh\` to analyze your mosquito sequences." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note:** This auto-grading checks workflow completion, not scientific correctness." >> $GITHUB_STEP_SUMMARY
        echo "Your instructor will review your results and species identifications." >> $GITHUB_STEP_SUMMARY

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Grade Assignment Answers
      id: grading
      env:
        ANSWER_KEY: ${{ secrets.ANSWER_KEY_JSON }}
      run: |
        echo "Grading assignment answers..."

        if [ ! -f "answers.json" ]; then
          echo "‚ùå answers.json not found - Please run python3 answer_assignment.py"
          echo "answers_graded=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        # Create answer key from secret
        echo "$ANSWER_KEY" > /tmp/answer_key.json

        # Run grading script
        python3 .github/grading/grade_answers.py answers.json /tmp/answer_key.json
        GRADE_EXIT_CODE=$?

        # Clean up answer key
        rm /tmp/answer_key.json

        if [ $GRADE_EXIT_CODE -eq 0 ]; then
          echo "answers_graded=pass" >> $GITHUB_OUTPUT
        else
          echo "answers_graded=fail" >> $GITHUB_OUTPUT
        fi

    - name: Set Completion Status
      run: |
        TUTORIAL_STATUS="${{ steps.tutorial.outputs.tutorial_completed }}"
        ANALYSIS_STATUS="${{ steps.analysis.outputs.analysis_completed }}"
        ANSWERS_STATUS="${{ steps.grading.outputs.answers_graded }}"

        echo ""
        echo "==================================="
        echo "FINAL STATUS:"
        echo "==================================="
        echo "Tutorial: $TUTORIAL_STATUS"
        echo "Analysis: $ANALYSIS_STATUS"
        echo "Answers: $ANSWERS_STATUS"
        echo "==================================="

        if [ "$TUTORIAL_STATUS" = "true" ] && [ "$ANALYSIS_STATUS" = "true" ] && [ "$ANSWERS_STATUS" = "pass" ]; then
          echo "‚úÖ ASSIGNMENT COMPLETE - All workflows finished and answers correct!"
          exit 0
        elif [ "$TUTORIAL_STATUS" = "false" ] && [ "$ANALYSIS_STATUS" = "false" ]; then
          echo "‚ùå ASSIGNMENT NOT STARTED - Please run tutorial.sh and run-analysis.sh"
          exit 1
        elif [ "$ANSWERS_STATUS" = "false" ]; then
          echo "‚ùå ANSWERS MISSING - Please run: python3 answer_assignment.py"
          exit 1
        elif [ "$ANSWERS_STATUS" = "fail" ]; then
          echo "‚ùå ANSWERS INCORRECT - Please review the feedback above"
          exit 1
        else
          echo "‚ö†Ô∏è ASSIGNMENT PARTIAL - Continue working to complete all parts"
          exit 1
        fi
